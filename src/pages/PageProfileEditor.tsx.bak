import { useState, useEffect } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { IoChevronDownOutline } from 'react-icons/io5'
import { useProfileStore } from '@/store/profileStore'
import { FormatProfile, StyleConfig } from '@/types/profile'

export function PageProfileEditor() {
  const navigate = useNavigate()
  const { id } = useParams<{ id: string }>()
  const { addProfile, updateProfile, getProfileById } = useProfileStore()

  const isEditing = id !== 'new'
  const existingProfile = isEditing ? getProfileById(id!) : null
  const isReadOnly = existingProfile?.isDefault || false

  const [formData, setFormData] = useState<Partial<FormatProfile>>({
    name: '',
    description: '',
    styles: {
      documentTitle: { fontFamily: '方正小标宋简体', fontSize: 22, lineSpacing: 35, alignment: 'center' },
      recipient: { fontFamily: '方正仿宋', fontSize: 16, lineSpacing: 28, alignment: 'left', spaceBefore: 28 },
      body: { fontFamily: '方正仿宋', fontSize: 16, lineSpacing: 28, firstLineIndent: 2 },
      heading1: { fontFamily: '方正黑体', fontSize: 16, lineSpacing: 28 },
      heading2: { fontFamily: '方正楷体', fontSize: 16, lineSpacing: 28 },
      heading3: { fontFamily: '方正仿宋', fontSize: 16, lineSpacing: 28 },
      heading4: { fontFamily: '方正仿宋', fontSize: 16, lineSpacing: 28 },
      signatureOrg: { fontFamily: '方正仿宋', fontSize: 16, alignment: 'right' },
      signatureDate: { fontFamily: '方正仿宋', fontSize: 16, alignment: 'right' },
    },
    specialRules: {
      autoTimesNewRoman: true,
      pageNumbering: {
        enabled: true,
        format: '- {page} -',
        startFromSecondPage: true,
      },
      attachment: {
        enabled: true,
        keywords: ['附件：', '附件1', '附件2'],
        fontFamily: '方正小标宋简体',
        fontSize: 22,
      },
    },
    pageMargins: {
      top: 37,
      bottom: 35,
      left: 28,
      right: 26,
    },
  })

  useEffect(() => {
    if (existingProfile) {
      setFormData(existingProfile)
    }
  }, [existingProfile])

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()

    if (!formData.name) {
      alert('请输入规范名称')
      return
    }

    const profileData: Omit<FormatProfile, 'id' | 'createdAt' | 'updatedAt'> = {
      name: formData.name,
      description: formData.description,
      styles: formData.styles!,
      specialRules: formData.specialRules!,
      pageMargins: formData.pageMargins!,
      isDefault: false,
    }

    if (isEditing && existingProfile) {
      updateProfile(existingProfile.id, profileData)
    } else {
      addProfile(profileData)
    }

    navigate('/profiles')
  }

  const updateStyleConfig = (styleName: keyof FormatProfile['styles'], field: keyof StyleConfig, value: any) => {
    setFormData((prev) => ({
      ...prev,
      styles: {
        ...prev.styles!,
        [styleName]: {
          ...prev.styles![styleName],
          [field]: value,
        },
      },
    }))
  }

  const StyleConfigForm = ({ label, styleName, config }: { label: string; styleName: keyof FormatProfile['styles']; config: StyleConfig }) => (
    <details className="group bg-gray-50 p-6 rounded-lg border border-gray-200">
      <summary className="text-xl font-medium text-gray-800 cursor-pointer list-none flex justify-between items-center">
        {label}
        <span className="text-indigo-600 transition-transform group-open:rotate-180">
          <IoChevronDownOutline />
        </span>
      </summary>
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
        <div>
          <label className="block text-sm font-medium text-gray-700">字体</label>
          <select
            value={config.fontFamily}
            onChange={(e) => updateStyleConfig(styleName, 'fontFamily', e.target.value)}
            disabled={isReadOnly}
            className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white disabled:bg-gray-100"
          >
            <option>方正小标宋简体</option>
            <option>方正仿宋</option>
            <option>方正黑体</option>
            <option>方正楷体</option>
            <option>宋体</option>
            <option>黑体</option>
            <option>仿宋_GB2312</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">字号 (磅)</label>
          <input
            type="number"
            value={config.fontSize}
            onChange={(e) => updateStyleConfig(styleName, 'fontSize', Number(e.target.value))}
            disabled={isReadOnly}
            className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
          />
        </div>
        {config.lineSpacing !== undefined && (
          <div>
            <label className="block text-sm font-medium text-gray-700">行距 (磅)</label>
            <input
              type="number"
              value={config.lineSpacing}
              onChange={(e) => updateStyleConfig(styleName, 'lineSpacing', Number(e.target.value))}
              disabled={isReadOnly}
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
            />
          </div>
        )}
        {config.alignment !== undefined && (
          <div>
            <label className="block text-sm font-medium text-gray-700">对齐方式</label>
            <select
              value={config.alignment}
              onChange={(e) => updateStyleConfig(styleName, 'alignment', e.target.value)}
              disabled={isReadOnly}
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm bg-white disabled:bg-gray-100"
            >
              <option value="left">左对齐</option>
              <option value="center">居中</option>
              <option value="right">右对齐</option>
              <option value="justify">两端对齐</option>
            </select>
          </div>
        )}
        {config.spaceBefore !== undefined && (
          <div>
            <label className="block text-sm font-medium text-gray-700">段前间距 (磅)</label>
            <input
              type="number"
              value={config.spaceBefore}
              onChange={(e) => updateStyleConfig(styleName, 'spaceBefore', Number(e.target.value))}
              disabled={isReadOnly}
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
            />
          </div>
        )}
        {config.spaceAfter !== undefined && (
          <div>
            <label className="block text-sm font-medium text-gray-700">段后间距 (磅)</label>
            <input
              type="number"
              value={config.spaceAfter}
              onChange={(e) => updateStyleConfig(styleName, 'spaceAfter', Number(e.target.value))}
              disabled={isReadOnly}
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
            />
          </div>
        )}
        {config.firstLineIndent !== undefined && (
          <div className="col-span-3">
            <label className="flex items-center mt-2">
              <input
                type="checkbox"
                checked={config.firstLineIndent > 0}
                onChange={(e) => updateStyleConfig(styleName, 'firstLineIndent', e.target.checked ? 2 : 0)}
                disabled={isReadOnly}
                className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <span className="ml-2 text-gray-700">首行缩进 (2字符)</span>
            </label>
          </div>
        )}
      </div>
    </details>
  )

  return (
    <div className="max-w-5xl mx-auto">
      <h1 className="text-3xl font-bold text-gray-900 mb-8">
        {isReadOnly ? `查看规范：${formData.name}` : isEditing ? `编辑规范：${formData.name}` : '新建规范'}
      </h1>

      <form onSubmit={handleSubmit} className="bg-white p-8 rounded-xl shadow-sm border border-gray-200 space-y-8">
        {/* 规范名称 */}
        <div>
          <label htmlFor="profile-name" className="block text-lg font-medium text-gray-800 mb-3">
            规范名称
          </label>
          <input
            type="text"
            id="profile-name"
            placeholder="例如：XX公司2025版规范"
            value={formData.name}
            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
            disabled={isReadOnly}
            className="w-full p-4 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100"
          />
          {isReadOnly && (
            <p className="text-sm text-gray-500 mt-2">预设规范不可修改名称。</p>
          )}
        </div>

        <div>
          <label htmlFor="profile-description" className="block text-lg font-medium text-gray-800 mb-3">
            规范描述（选填）
          </label>
          <textarea
            id="profile-description"
            placeholder="描述此规范的用途..."
            value={formData.description}
            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
            disabled={isReadOnly}
            rows={3}
            className="w-full p-4 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100"
          />
        </div>

        <hr />

        {/* 样式映射配置 */}
        <h2 className="text-2xl font-semibold text-gray-900">样式映射配置</h2>
        <p className="text-gray-600 -mt-6">设置规范如何映射Word中的【样式】。字号单位为"磅"(pt)。 (注: 三号=16pt, 二号=22pt)</p>

        <div className="space-y-4">
          <StyleConfigForm label="文档标题 (映射: Title)" styleName="documentTitle" config={formData.styles!.documentTitle} />
          <StyleConfigForm label="主送单位 (映射: Heading 6)" styleName="recipient" config={formData.styles!.recipient} />
          <StyleConfigForm label="正文 (映射: Normal)" styleName="body" config={formData.styles!.body} />
          <StyleConfigForm label="一级标题 (映射: Heading 1)" styleName="heading1" config={formData.styles!.heading1} />
          <StyleConfigForm label="二级标题 (映射: Heading 2)" styleName="heading2" config={formData.styles!.heading2} />
          <StyleConfigForm label="三级标题 (映射: Heading 3)" styleName="heading3" config={formData.styles!.heading3} />
          <StyleConfigForm label="四级标题 (映射: Heading 4)" styleName="heading4" config={formData.styles!.heading4} />
          
          <details className="group bg-gray-50 p-6 rounded-lg border border-gray-200">
            <summary className="text-xl font-medium text-gray-800 cursor-pointer list-none flex justify-between items-center">
              落款 (映射: Heading 7 & 8)
              <span className="text-indigo-600 transition-transform group-open:rotate-180">
                <IoChevronDownOutline />
              </span>
            </summary>
            <p className="text-sm text-gray-600 mt-4">用户应将 "落款单位" 设为 "标题 7"，"落款日期" 设为 "标题 8"。</p>
            
            <h4 className="text-lg font-semibold text-gray-700 mt-4">落款单位 (Heading 7)</h4>
            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
              <div>
                <label className="block text-sm font-medium text-gray-700">字体</label>
                <input
                  type="text"
                  value={formData.styles!.signatureOrg.fontFamily}
                  onChange={(e) => updateStyleConfig('signatureOrg', 'fontFamily', e.target.value)}
                  disabled={isReadOnly}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">字号 (磅)</label>
                <input
                  type="number"
                  value={formData.styles!.signatureOrg.fontSize}
                  onChange={(e) => updateStyleConfig('signatureOrg', 'fontSize', Number(e.target.value))}
                  disabled={isReadOnly}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
                />
              </div>
            </div>

            <h4 className="text-lg font-semibold text-gray-700 mt-6">落款日期 (Heading 8)</h4>
            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
              <div>
                <label className="block text-sm font-medium text-gray-700">字体</label>
                <input
                  type="text"
                  value={formData.styles!.signatureDate.fontFamily}
                  onChange={(e) => updateStyleConfig('signatureDate', 'fontFamily', e.target.value)}
                  disabled={isReadOnly}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">字号 (磅)</label>
                <input
                  type="number"
                  value={formData.styles!.signatureDate.fontSize}
                  onChange={(e) => updateStyleConfig('signatureDate', 'fontSize', Number(e.target.value))}
                  disabled={isReadOnly}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100"
                />
              </div>
            </div>
          </details>
        </div>

        <hr />

        {/* 特殊规则处理器 */}
        <h2 className="text-2xl font-semibold text-gray-900">特殊规则处理器</h2>
        <p className="text-gray-600 -mt-6">应用于整个文档的全局规则。</p>

        <div className="space-y-4">
          <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <label className="flex items-center">
              <input
                type="checkbox"
                checked={formData.specialRules!.autoTimesNewRoman}
                onChange={(e) => setFormData({
                  ...formData,
                  specialRules: { ...formData.specialRules!, autoTimesNewRoman: e.target.checked }
                })}
                disabled={isReadOnly}
                className="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <span className="ml-3 text-lg font-medium text-gray-800">自动将数字/英文设为 "Times New Roman"</span>
            </label>
            <p className="text-gray-600 ml-8 mt-2">遍历文档，将所有半角数字和英文字母的字体强制设置为 "Times New Roman"，而不影响周围的中文汉字。</p>
          </div>

          <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <label className="flex items-center">
              <input
                type="checkbox"
                checked={formData.specialRules!.pageNumbering.enabled}
                onChange={(e) => setFormData({
                  ...formData,
                  specialRules: {
                    ...formData.specialRules!,
                    pageNumbering: { ...formData.specialRules!.pageNumbering, enabled: e.target.checked }
                  }
                })}
                disabled={isReadOnly}
                className="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <span className="ml-3 text-lg font-medium text-gray-800">自动设置页码</span>
            </label>
            <p className="text-gray-600 ml-8 mt-2">设置页码格式：首页不显示页码，从第二页起显示。</p>
          </div>

          <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <label className="flex items-center">
              <input
                type="checkbox"
                checked={formData.specialRules!.attachment.enabled}
                onChange={(e) => setFormData({
                  ...formData,
                  specialRules: {
                    ...formData.specialRules!,
                    attachment: { ...formData.specialRules!.attachment, enabled: e.target.checked }
                  }
                })}
                disabled={isReadOnly}
                className="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <span className="ml-3 text-lg font-medium text-gray-800">自动处理附件格式</span>
            </label>
            <p className="text-gray-600 ml-8 mt-2">基于关键词（如"附件："或"附件1"）自动格式化附件标题。</p>
          </div>
        </div>

        {/* 保存按钮 */}
        <div className="flex justify-end pt-6 border-t space-x-4">
          <button
            type="button"
            onClick={() => navigate('/profiles')}
            className="bg-gray-500 text-white font-medium py-3 px-6 rounded-lg hover:bg-gray-600 transition-all"
          >
            返回列表
          </button>
          {!isReadOnly && (
            <button
              type="submit"
              className="bg-indigo-600 text-white font-medium py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-all"
            >
              保存规范
            </button>
          )}
        </div>
      </form>
    </div>
  )
}
